#!/usr/bin/python

import re
import yaml
import logging
import config
from peewee import SqliteDatabase
from gtfeed.gtfeed import GT, TorrentModel

with open("config.yml", 'r') as ymlfile:
	config.cfg = yaml.load(ymlfile)
	config.db = SqliteDatabase(config.cfg['general']['db_path'])


# filters = []  # If empty then no torrents will be downloaded
# filters should be valid python regular expressions
filters = config.cfg['filtering']['filters']

logging.basicConfig()
logging.getLogger().setLevel(logging.DEBUG)

log = logging.getLogger("GT")

if __name__ == "__main__":
	gt = GT("username", "password")
	if not gt.login():
		log.error("Could not log in")
	else:
		torrent_list = gt.check_shoutbox(
			[re.compile(f, re.IGNORECASE) if config.cfg['filtering']['ignore_case'] else re.compile(f) for f in filters])
		for t in torrent_list:
			if GT.downloaded(t):
				log.debug("Torrent %s with id %d has already been downloaded, skipping..." % (t.name, t.torrent_id))
			else:
				gt.download_torrent(t)
				TorrentModel.create(torrent_id=t.torrent_id, name=t.name, uploaded_by=t.uploaded_by)
